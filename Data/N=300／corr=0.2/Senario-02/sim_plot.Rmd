---
title: "Master's Thesis: Simulations"
author: "Ryo Mishima"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  ## HTML
  distill::distill_article:
    toc: true
    toc_depth: 2
    md_extensions: -ascii_identifiers
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  out.width = "\\textwidth", fig.align = "center", fig.pos = "t")

# 表示桁数
options(digits=3)

library(dplyr)

# フォント周り
library(systemfonts)
family_sans  <- "MS Gothic"  ## "Noto Sans CJK JP"
family_serif <- "MS Mincho"  ## "Noto Serif JP"

options(knitr.duplicate.label = 'allow')
```

```{r, include=FALSE}
# (1) For dataframes
# PSM, CEM, CART, RF, MRT
# Do the following:
# ・Remove the sequential numbers in leftmost column
# ・Convert to comma-separated format
# Align values vertically in each column, and add commas at the end of all lines except the last one.

# (2) For dataframes
# Var.Imp.CART, Var.Imp.MRT
# Do the following:
# Remove the sequential numbers on the left, and replace them with numbers 10,8,6,5,4,3,2,1
# Align values vertically in each column, and add commas at the end of all lines except the last one.
```

```{r}
PSM = matrix(c(
  300, 0.100, 296, 0.178, 0.294, 4.39, 0.987, 0.230, 0,
  300, 0.050, 292, 0.166, 0.267, 2.31, 0.977, 0.196, 0,
  300, 0.025, 282, 0.170, 0.245, 1.49, 0.959, 0.153, 0,
  300, 0.020, 275, 0.172, 0.245, 1.37, 0.946, 0.143, 0,
  300, 0.010, 239, 0.153, 0.224, 1.18, 0.955, 0.116, 0,
  300, 0.008, 223, 0.138, 0.214, 1.15, 0.959, 0.109, 0,
  300, 0.005, 180, 0.110, 0.206, 1.20, 0.974, 0.123, 0,
  300, 0.004, 159, 0.098, 0.203, 1.23, 0.980, 0.131, 0
), nrow=8, byrow=TRUE)

colnames(PSM) = c("Total", "Caliper", "N", "Bias", "RMSE", "Width.CI", "Coverage", "EDA.range", "Fail")
```

```{r}
CEM = matrix(c(
  300, 10, 54.8, 0.135, 0.365, 2.47, 0.959, 0.326, 0
), nrow=1, byrow=TRUE)

colnames(CEM) = c("Total", "N.var", "N", "Bias", "RMSE", "Width.CI", "Coverage", "EDA.range", "Fail")
```

```{r}
CART = matrix(c(
  300, 10, 293, 0.176, 0.264, 1.77, 0.961, 0.211, 0,
  300,  8, 288, 0.162, 0.241, 1.54, 0.961, 0.185, 0,
  300,  6, 278, 0.153, 0.226, 1.33, 0.960, 0.163, 0,
  300,  5, 269, 0.150, 0.223, 1.21, 0.958, 0.149, 0,
  300,  4, 254, 0.138, 0.212, 1.12, 0.960, 0.138, 0,
  300,  3, 228, 0.130, 0.210, 1.06, 0.954, 0.128, 0,
  300,  2, 180, 0.111, 0.208, 1.02, 0.954, 0.131, 0
), nrow=7, byrow=TRUE)

colnames(CART) = c("Total", "min.bucket", "N", "Bias", "RMSE", "Width.CI", "Coverage", "EDA.range", "Fail")
```

```{r}
RF = matrix(c(
  300,  2, 299, 0.358, 0.416, 3.70, 0.905, 0.335, 0,
  300,  3, 285, 0.253, 0.314, 1.84, 0.924, 0.274, 0,
  300,  4, 274, 0.199, 0.268, 1.70, 0.949, 0.265, 0,
  300,  5, 243, 0.124, 0.217, 1.42, 0.969, 0.188, 0,
  300,  6, 237, 0.120, 0.216, 1.40, 0.969, 0.185, 0,
  300,  7, 224, 0.113, 0.210, 1.39, 0.967, 0.181, 0,
  300,  8, 206, 0.104, 0.210, 1.39, 0.970, 0.179, 0,
  300,  9, 199, 0.104, 0.215, 1.39, 0.967, 0.180, 0,
  300, 10, 172, 0.099, 0.221, 1.40, 0.967, 0.179, 0
), nrow=9, byrow=TRUE)

colnames(RF) = c("Total", "num.trees", "N", "Bias", "RMSE", "Width.CI", "Coverage", "EDA.range", "Fail")
```

```{r}
MRT = matrix(c(
  300, 10, 295, 0.243, 0.314, 1.86, 0.940, 0.245, 0,
  300,  8, 291, 0.223, 0.292, 1.63, 0.939, 0.226, 0,
  300,  6, 283, 0.209, 0.271, 1.42, 0.944, 0.196, 0,
  300,  5, 277, 0.207, 0.275, 1.33, 0.931, 0.200, 0,
  300,  4, 265, 0.193, 0.260, 1.28, 0.939, 0.183, 0,
  300,  3, 248, 0.183, 0.249, 1.18, 0.947, 0.178, 0,
  300,  2, 219, 0.172, 0.246, 1.14, 0.941, 0.168, 0,
  300,  1, 171, 0.154, 0.243, 1.19, 0.943, 0.175, 0
), nrow=8, byrow=TRUE)

colnames(MRT) = c("Total", "min.bucket", "N", "Bias", "RMSE", "Width.CI", "Coverage", "EDA.range", "Fail")
```

```{r}
# SIRUS = matrix(c(

# ), nrow=9) %>% t()
# 
# colnames(SIRUS)=c("Total","num.rules","N","Bias","RMSE","Width.CI","Coverage","EDA.range","Fail")
```

```{r}
Var.Imp.CART = matrix(c(
  10, 2.87, 0.698, 0.069, 4.08, 1.20, 0.107, 0.270, 0.250, 0.089, 0.272,
   8, 2.88, 0.719, 0.075, 4.05, 1.19, 0.110, 0.271, 0.251, 0.091, 0.272,
   6, 2.89, 0.746, 0.087, 4.03, 1.18, 0.113, 0.271, 0.251, 0.095, 0.272,
   5, 2.90, 0.758, 0.095, 4.01, 1.17, 0.115, 0.271, 0.250, 0.096, 0.272,
   4, 2.90, 0.769, 0.102, 4.00, 1.17, 0.115, 0.269, 0.250, 0.097, 0.271,
   3, 2.90, 0.785, 0.112, 3.99, 1.16, 0.115, 0.268, 0.249, 0.096, 0.269,
   2, 2.89, 0.795, 0.121, 3.98, 1.15, 0.115, 0.265, 0.246, 0.095, 0.266,
   1, 2.89, 0.795, 0.121, 3.98, 1.15, 0.115, 0.265, 0.246, 0.095, 0.266
), nrow=8, byrow=TRUE)

colnames(Var.Imp.CART) = c("min.bucket", "X01", "X02", "X03", "X04", "X05", "X06", "X07", "X08", "X09", "X10")
```


```{r}
Var.Imp.MRT = matrix(c(
  10, 0.892, 0.359, 0.034, 1.62, 0.526, 0.048, 0.130, 0.131, 0.040, 0.148,
   8, 0.953, 0.380, 0.038, 1.69, 0.546, 0.052, 0.135, 0.137, 0.042, 0.154,
   6, 1.025, 0.405, 0.044, 1.76, 0.565, 0.056, 0.141, 0.142, 0.045, 0.160,
   5, 1.064, 0.418, 0.047, 1.79, 0.573, 0.058, 0.143, 0.145, 0.046, 0.163,
   4, 1.108, 0.434, 0.051, 1.83, 0.583, 0.060, 0.145, 0.148, 0.048, 0.166,
   3, 1.156, 0.450, 0.057, 1.87, 0.590, 0.062, 0.147, 0.150, 0.049, 0.168,
   2, 1.203, 0.468, 0.064, 1.90, 0.595, 0.063, 0.148, 0.152, 0.050, 0.170,
   1, 1.243, 0.484, 0.073, 1.92, 0.596, 0.064, 0.148, 0.152, 0.051, 0.171
), nrow=8, byrow=TRUE)

colnames(Var.Imp.MRT) = c("min.bucket", "X01", "X02", "X03", "X04", "X05", "X06", "X07", "X08", "X09", "X10")
```

```{r}
# Make a basic graph
plot( PSM[,"Bias"] ~ PSM[,"N"],        type="b", col="orange",     lwd=3, pch=15, 
      bty="l", xlab="Number at analysis", ylab="Bias", xlim=c(300, 0), ylim=c(-0.2, 0.4) )
lines(CART[,"Bias"] ~ CART[,"N"],      type="b", col="skyblue",    lwd=3, pch=16)
lines(RF[,"Bias"] ~ RF[,"N"],          type="b", col="lightgreen", lwd=3, pch=17)
lines(MRT[,"Bias"] ~ MRT[,"N"],  type="b", col="seagreen",      lwd=3, pch=18)
# lines(SIRUS[,"Bias"] ~ SIRUS[,"N"],    type="b", col="seagreen",   lwd=3, pch=19)
abline(h=0, col="gray", lwd=3, lty=2)

points(CEM[,"N"], CEM[,"Bias"], type="p", col="blue", cex=2, pch=4)
 
# Add a legend
legend("bottomleft", xpd=TRUE,
  legend = c("PSM", "CEM", "CART", "RF", "MRT"), #, "SIRUS"), 
  col = c("orange", "blue", "skyblue", "lightgreen","seagreen"), #,"seagreen"),
  pch = c(15, 4, 17, 18, 19), 
  bty = "n", 
  pt.cex = 1.5,
  text.col = "black", 
  horiz = TRUE, 
  inset = c(0.1, 0.1, 0.1, 0.1, 0.1))

title("(a)", line = -0.5)
```

```{r}
# Make a basic graph
plot( PSM[,"Width.CI"] ~ PSM[,"N"],        type="b", col="orange",     lwd=3, pch=15, 
      bty="l", xlab="Number at analysis", ylab="Width.CI", xlim=c(300, 0), ylim=c(0, 5) )
lines(CART[,"Width.CI"] ~ CART[,"N"],      type="b", col="skyblue",    lwd=3, pch=16)
lines(RF[,"Width.CI"] ~ RF[,"N"],          type="b", col="lightgreen", lwd=3, pch=17)
lines(MRT[,"Width.CI"] ~ MRT[,"N"],  type="b", col="seagreen",      lwd=3, pch=18)
# lines(SIRUS[,"Width.CI"] ~ SIRUS[,"N"],    type="b", col="seagreen",   lwd=3, pch=19)
abline(h=0, col="gray", lwd=3, lty=2)

points(CEM[,"N"], CEM[,"Width.CI"], type="p", col="blue", cex=2, pch=4)
 
# Add a legend
legend("topleft", xpd=TRUE,
  legend = c("PSM", "CEM", "CART", "RF", "MRT"), #, "SIRUS"), 
  col = c("orange", "blue", "skyblue", "lightgreen","seagreen"), #,"seagreen"),
  pch = c(15, 4, 17, 18, 19), 
  bty = "n", 
  pt.cex = 1.5,
  text.col = "black", 
  horiz = TRUE, 
  inset = c(0.1, 0.1, 0.1, 0.1, 0.1))

title("(b)", line = -0.5)
```

```{r}
# Make a basic graph
plot( PSM[,"RMSE"] ~ PSM[,"N"],        type="b", col="orange",     lwd=3, pch=15, 
      bty="l", xlab="Number at analysis", ylab="RMSE", xlim=c(300, 0), ylim=c(0,0.5) )
lines(CART[,"RMSE"] ~ CART[,"N"],      type="b", col="skyblue",    lwd=3, pch=16)
lines(RF[,"RMSE"] ~ RF[,"N"],          type="b", col="lightgreen", lwd=3, pch=17)
lines(MRT[,"RMSE"] ~ MRT[,"N"],  type="b", col="seagreen",      lwd=3, pch=18)
# lines(SIRUS[,"RMSE"] ~ SIRUS[,"N"],    type="b", col="seagreen",   lwd=3, pch=19)
abline(h=0, col="gray", lwd=3, lty=2)

points(CEM[,"N"], CEM[,"RMSE"], type="p", col="blue", cex=2, pch=4)
 
# Add a legend
legend("bottomleft", xpd=TRUE,
  legend = c("PSM", "CEM", "CART", "RF", "MRT"), #, "SIRUS"), 
  col = c("orange", "blue", "skyblue", "lightgreen","seagreen"), #,"seagreen"),
  pch = c(15, 4, 17, 18, 19), 
  bty = "n", 
  pt.cex = 1.5,
  text.col = "black", 
  horiz = TRUE, 
  inset = c(0.1, 0.1, 0.1, 0.1, 0.1))

title("(c)", line = -0.5)
```

```{r}
# Make a basic graph
plot( PSM[,"Coverage"] ~ PSM[,"N"],        type="b", col="orange",     lwd=3, pch=15, 
      bty="l", xlab="Number at analysis", ylab="Coverage", xlim=c(300, 0), ylim=c(0.7,1.0) )
lines(CART[,"Coverage"] ~ CART[,"N"],      type="b", col="skyblue",    lwd=3, pch=16)
lines(RF[,"Coverage"] ~ RF[,"N"],          type="b", col="lightgreen", lwd=3, pch=17)
lines(MRT[,"Coverage"] ~ MRT[,"N"],  type="b", col="seagreen",      lwd=3, pch=18)
# lines(SIRUS[,"Coverage"] ~ SIRUS[,"N"],    type="b", col="seagreen",   lwd=3, pch=19)
abline(h=0.95, col="gray", lwd=3, lty=2)

points(CEM[,"N"], CEM[,"Coverage"], type="p", col="blue", cex=2, pch=4)
 
# Add a legend
legend("bottomleft", xpd=TRUE,
  legend = c("PSM", "CEM", "CART", "RF", "MRT"), #, "SIRUS"), 
  col = c("orange", "blue", "skyblue", "lightgreen","seagreen"), #,"seagreen"),
  pch = c(15, 4, 17, 18, 19), 
  bty = "n", 
  pt.cex = 1.5,
  text.col = "black", 
  horiz = TRUE, 
  inset = c(0.1, 0.1, 0.1, 0.1, 0.1))


title("(d)", line = -0.5)
```

```{r}
# Make a basic graph
plot( PSM[,"EDA.range"] ~ PSM[,"N"],        type="b", col="orange",     lwd=3, pch=15, 
      bty="l", xlab="Number at analysis", ylab="range for exploratory", xlim=c(300, 150), ylim=c(0,0.4) )
lines(CART[,"EDA.range"] ~ CART[,"N"],      type="b", col="skyblue",    lwd=3, pch=16)
lines(RF[,"EDA.range"] ~ RF[,"N"],          type="b", col="lightgreen", lwd=3, pch=17)
lines(MRT[,"EDA.range"] ~ MRT[,"N"],  type="b", col="seagreen",      lwd=3, pch=18)
# lines(SIRUS[,"EDA.range"] ~ SIRUS[,"N"],    type="b", col="seagreen",   lwd=3, pch=19)
abline(h=0.0, col="gray", lwd=3, lty=2)

# points(CEM[,"N"], CEM[,"EDA.range"], type="p", col="blue", cex=2, pch=4)
 
# Add a legend
legend("topleft", xpd=TRUE,
  legend = c("PSM", "CART", "RF", "MRT"), #, "SIRUS"), 
  col = c("orange", "skyblue", "lightgreen","seagreen"), #,"seagreen"),
  pch = c(15, 17, 18, 19), 
  bty = "n", 
  pt.cex = 1.5,
  text.col = "black", 
  horiz = TRUE, 
  inset = c(0.1, 0.1, 0.1, 0.1))

title("(e)", line = -0.5)
```

```{r}
# データを長形式に変換
require(tidyr)
Var.Imp.CART_long <- Var.Imp.CART %>%
  as.data.frame() %>%
  filter(min.bucket==10) %>% 
  select(-min.bucket) %>%
  gather(key = "Variable", value = "Value") %>%
  mutate(Method = "CART")

Var.Imp.MRT_long <- Var.Imp.MRT %>%
  as.data.frame() %>%
  filter(min.bucket==10) %>% 
  select(-min.bucket) %>%
  gather(key = "Variable", value = "Value") %>%
  mutate(Method = "MRT")

# データを結合
combined_data <- rbind(Var.Imp.CART_long, Var.Imp.MRT_long)

# プロット作成
require(ggplot2)
ggplot(combined_data, aes(x = Variable, y = Value, fill = Method)) +
geom_bar(stat = "identity", position = "dodge", width = 0.7) +
theme_minimal() +
labs(
  x = "Variables",
  y = "Variance of Variable Importance"
  #title = "Variance of Variable Importance: CART vs MRT"
) +
scale_fill_manual(values = c("CART" = "skyblue", "MRT" = "seagreen")) +
theme(
  axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
  axis.text.y = element_text(size = 12),
  legend.position = c(0.85, 0.85),
  legend.text = element_text(size = 12),
  legend.title = element_text(size = 14),
  axis.title.x = element_text(size = 14),
  axis.title.y = element_text(size = 14)
  # panel.grid.major = element_line(color = "#CCCCCC"),
  # panel.grid.minor = element_line(color = "#EEEEEE"),
  # plot.background = element_rect(fill = "white"),
  # legend.background = element_rect(fill = "white")
)

